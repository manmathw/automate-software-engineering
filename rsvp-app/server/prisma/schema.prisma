generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OccasionType {
  BIRTHDAY
  ANNIVERSARY
  WEDDING
  GRADUATION
  CORPORATE
  BABY_SHOWER
  RETIREMENT
  HOLIDAY_PARTY
  OTHER
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum RsvpResponse {
  YES
  NO
  MAYBE
  PENDING
}

enum EmailStatus {
  QUEUED
  SENT
  FAILED
  BOUNCED
}

enum AuthProvider {
  LOCAL
  GOOGLE
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  name         String
  passwordHash String?
  provider     AuthProvider  @default(LOCAL)
  googleId     String?       @unique
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  events       Event[]
  refreshTokens RefreshToken[]
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model Event {
  id           String       @id @default(cuid())
  title        String
  description  String?
  occasionType OccasionType
  status       EventStatus  @default(DRAFT)
  eventDate    DateTime
  venue        String?
  templateId   String       @default("classic")
  organizerId  String
  organizer    User         @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  guests       Guest[]
  emailLogs    EmailLog[]
  reminderJobs ReminderJob[]
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
}

model Guest {
  id               String       @id @default(cuid())
  eventId          String
  event            Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  firstName        String
  lastName         String
  email            String
  invitationToken  String       @unique @default(uuid())
  plusOneAllowed   Boolean      @default(false)
  rsvp             Rsvp?
  emailLogs        EmailLog[]
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@unique([eventId, email])
}

model Rsvp {
  id                  String       @id @default(cuid())
  guestId             String       @unique
  guest               Guest        @relation(fields: [guestId], references: [id], onDelete: Cascade)
  response            RsvpResponse @default(PENDING)
  plusOneCount        Int          @default(0)
  dietaryPreferences  String?
  message             String?
  respondedAt         DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
}

model EmailLog {
  id       String      @id @default(cuid())
  eventId  String
  event    Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  guestId  String?
  guest    Guest?      @relation(fields: [guestId], references: [id], onDelete: SetNull)
  type     String
  status   EmailStatus @default(QUEUED)
  resendId String?
  toEmail  String
  sentAt   DateTime?
  createdAt DateTime   @default(now())
}

model ReminderJob {
  id        String   @id @default(cuid())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  triggerAt DateTime
  type      String
  sent      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@unique([eventId, type])
}
